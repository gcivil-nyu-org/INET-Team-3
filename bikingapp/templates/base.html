<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <meta http-equiv="X-UA-Compatible" content="ie=edge" />
  {% load static %}
  <link rel="stylesheet" href="{% static '/css/base.css' %}" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-Zenh87qX5JnK2Jl0vWa8Ck2rdkQ2Bzep5IDxbcnCeuOxjzrPF/et3URy9Bv1WTRi" crossorigin="anonymous" />
  <title>Home</title>
  <script type="text/javascript">
    var user = "{{request.user}}";
    function getToken(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== "") {
        const cookies = document.cookie.split(";");
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          // Does this cookie string begin with the name we want?
          if (cookie.substring(0, name.length + 1) === name + "=") {
            cookieValue = decodeURIComponent(
              cookie.substring(name.length + 1)
            );
            break;
          }
        }
      }
      return cookieValue;
    }
    const csrftoken = getToken("csrftoken");
  </script>
</head>

<body>
    <header>
        <nav role = "navigation">
            <ul>
                <li><a href="/">Home</a></li>
                <li><a href="/log_workout"> Log Workout </a></li>
                <li><a href="/workout_history"> Workout History </a></li>
                <li><a href="/create_event">Create Events</a></li>
                <li><a href="/browse_events">Browse Events</a></li>
                <li><a href="/map"> Map </a></li>
                <li><a href="/post">Discussion Forum</a></li>
                {% if user.is_authenticated %}
                <li><a href="/post/new">Create Post</a></li>
                <li><a href="{% url 'profile' user.username %}">Profile</a></li>
                <li><a href="/logout">Log Out</a></li>
                {% else %}
                <li><a href="/register">Register</a></li>
                <li><a href="/login">Log In</a></li>
                {% endif %}
            </ul>
        </nav>  
    </header>
   
    <div style = "margin-top: 100px; margin-left: 40px">
            {% include 'messaging.html' %}
            {% block content %}
            {% endblock content%}
    </div>
    <script type="text/javascript">
        var bookmarkBtns = document.getElementsByClassName("event-bookmark");

    for (var i = 0; i < bookmarkBtns.length; i++) {
      bookmarkBtns[i].addEventListener("click", function () {
        var eventId = this.dataset.event;
        var action = this.dataset.action;
        console.log("eventId:", eventId, "action:", action);
        console.log("USER:", user);
        if (user === "AnonymousUser") {
          console.log("not logged in");
        } else {
          bookmarkUserEvent(eventId, action);
        }
      });
    }

    function bookmarkUserEvent(eventId, action) {
      console.log("User is authenticated, sending data");
      var url = "/bookmark_event/";
      console.log("URL:", url)
      fetch(url, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": csrftoken,
        },
        body: JSON.stringify({
          'eventId': eventId,
          'action': action,
        }),
      })
        .then((response) => {
          return response.json();
        })
        .then((data) => {
          location.reload();
          console.log("data:", data);

        });
    }

    var remove_friendsBtns = document.getElementsByClassName("remove-friend");

    for (var i = 0; i < remove_friendsBtns.length; i++) {
      remove_friendsBtns[i].addEventListener("click", function () {
        var friend_username = this.dataset.friend_username;
        console.log("Friend Username:", friend_username);
        if (user === "AnonymousUser") {
          console.log("not logged in");
        } else {
          removeFreiend(friend_username);
        }
      });
    }

    function removeFreiend(friend_username) {
      console.log("User is authenticated, sending data");
      var url = "/remove_friend/";
      console.log("URL:", url)
      fetch(url, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": csrftoken,
        },
        body: JSON.stringify({
          'friend_username': friend_username,
        }),
      })
        .then((response) => {
          return response.json();
        })
        .then((data) => {
          location.reload();
          console.log("data:", data);

        });
    }

  </script>
</body>

</html>